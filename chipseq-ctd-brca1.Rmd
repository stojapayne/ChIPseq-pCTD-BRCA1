---
title: "U2OS BRCA1 RNAPII ChIP"
author: "Aiola Stoja"
date: '2022-12-29'
output: html_document
---

## ChIP peaks coverage plot 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(BiocManager)
library(ChIPseeker)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene
library(clusterProfiler)
#library(remotes) ##used to install seqUtils package to use loadNarrowPeaks (below)
#remotes::install_github("kauralasoo/seqUtils")
library(seqUtils)
library(ggpubr)
library(ggplot2)
library(ggupset)
library(ggimage)
library(ReactomePA)
library(dplyr)
library(stringr)

peak <- loadNarrowPeaks( "U2OS_narrowpeaks", c("U2OSRNAPIIdmso1_callpeaknoabC", "U2OSRNAPIIetop_callpeaknoabC",
                                               "U2OSBRCA1nt_callpeaknoabC", "U2OSBRCA1etop_callpeaknoabC"
                                               ),
                peaks_suffix = "_peaks.narrowPeak", 
                sub_dir = FALSE)

covplot <- covplot(peak, weightCol="score", chrs=c("chr17"), xlim=c(4.5e7, 5e7))
covplot + facet_grid(~factor (.id,levels = c( "U2OSRNAPIIdmso1_callpeaknoabC" , "U2OSRNAPIIetop_callpeaknoabC" ,
                                            "U2OSBRCA1nt_callpeaknoabC" , "U2OSBRCA1etop_callpeaknoabC"))) +
  theme(legend.position="none")

```



## Heatmap of ChIP peaks binding to TSS regions
```{r setup, include=FALSE, echo=FALSE}

promoter <- getPromoters(TxDb=txdb, upstream=3000, downstream=3000)

tagMatrix <- lapply(peak, getTagMatrix, windows=promoter)
tagMatrix<- tagMatrix[c(c("U2OSRNAPIIdmso1_callpeaknoabC", "U2OSRNAPIIetop_callpeaknoabC", "U2OSBRCA1nt_callpeaknoabC",
                          "U2OSBRCA1etop_callpeaknoabC"))]

lapply(names(tagMatrix), function(x) tagHeatmap(tagMatrix[[x]], xlim=c(-3000, 3000), color="red", xlab="Genomic Region (5'-3')", title=names(tagMatrix[x])))

```


## Average profile plot of ChIP peaks binding to TSS region
```{r setup, include=FALSE, echo=FALSE}

plotAvgProf(tagMatrix, xlim=c(-3000, 3000),
            xlab="Genomic Region (5'->3')", ylab = "Read Count Frequency")


lapply(names(tagMatrix), function(x) plotAvgProf(tagMatrix[[x]], xlim=c(-3000, 3000),
                                                 xlab="Genomic Region (5'->3')", ylab =
                                                   "Read Count Frequency",
                                                 conf=0.95, resample=1000))

```


## Peak Annotation

```{r setup, include=FALSE, echo=FALSE}

peakAnno <- annotatePeak(peak[[2]], tssRegion=c(-3000, 3000),
                         TxDb=txdb, annoDb="org.Hs.eg.db")
peakAnnoBRCA1dmso<-annotatePeak(peak[[1]], tssRegion=c(-3000,3000), TxDb=txdb, annoDb="org.Hs.eg.db")
peakAnnoBRCA1etop<-annotatePeak(peak[[2]], tssRegion=c(-3000, 3000), TxDb=txdb, annoDb="org.Hs.eg.db")
peakAnnoRNAPIIdmso<-annotatePeak(peak[[3]], tssRegion=c(-3000,3000), TxDb=txdb, annoDb="org.Hs.eg.db")
peakAnnoRNAPIIetop<-annotatePeak(peak[[4]], tssRegion=c(-3000,3000), TxDb=txdb, annoDb="org.Hs.eg.db")

peakAnnoDFRNAPIIetop<- as.data.frame(peakAnnoRNAPIIetop) %>%
  filter(str_detect(annotation, "Promoter"))
peakAnnoDFRNAPIIdmso<- as.data.frame(peakAnnoRNAPIIdmso) %>%
  filter(str_detect(annotation, "Promoter"))
peakAnnoDFBRCA1etop<-as.data.frame(peakAnnoBRCA1etop) %>%
  filter(str_detect(annotation, "Promoter"))
peakAnnoDFBRCA1dmso<-as.data.frame(peakAnnoBRCA1dmso) %>%
  filter(str_detect(annotation, "Promoter"))


```

## Functional enrichment analysis
```{r setup, include=FALSE, echo=FALSE}

BRCA1dmsopathway<-enrichPathway(as.data.frame(peakAnno)$geneId)
BRCA1etoppathway<- enrichPathway(as.data.frame(peakAnno)$geneId)
RNAPIIdmsopathway<- enrichPathway(as.data.frame(peakAnno)$geneId)
RNAPIIetoppathway<- enrichPathway(as.data.frame(peakAnno)$geneId)

head(BRCA1dmsopathway)

BRCA1dmsogene <- seq2gene(peak[[1]], tssRegion = c(-1000, 1000), flankDistance = 3000, TxDb=txdb)
BRCA1etopgene<- seq2gene(peak[[2]], tssRegion = c(-1000, 1000), flankDistance = 3000, TxDb=txdb)
RNAPIIdmsogene<- seq2gene(peak[[3]], tssRegion = c(-1000, 1000), flankDistance = 3000, TxDb=txdb)
RNAPIIetopgene<- seq2gene(peak[[4]], tssRegion = c(-1000, 1000), flankDistance = 3000, TxDb=txdb)

BRCA1dmsopathway2 <- enrichPathway(BRCA1dmsogene)
BRCA1etoppathway2 <- enrichPathway(BRCA1etopgene)
RNAPIIdmsopathway2 <- enrichPathway(RNAPIIdmsogene)
RNAPIIetoppathway2 <- enrichPathway(RNAPIIdmsogene)

head(RNAPIIdmsopathway2)
head(RNAPIIetoppathway2)

dotplot(RNAPIIetoppathway2)

```


# Reactome pathway enrichment analysis; promoters only

```{r setup, include=FALSE, echo=FALSE}

RNAPIIdmsoPromoterReactome<-enrichPathway(peakAnnoDFRNAPIIdmso$geneId)
RNAPIIdmsoPromoterGene<-seq2gene(peak[[3]], tssRegion=c(-1000,1000), flankDistance = 3000, TxDb=txdb)
RNAPIIdmsoPromoterpathway2<-enrichPathway(RNAPIIdmsoPromoterGene)
dotplot(RNAPIIdmsoPromoterpathway2)

RNAPIIetopPromoterReactome<-enrichPathway(peakAnnoDFRNAPIIetop$geneId)
RNAPIIetopPromoterGene<-seq2gene(peak[[4]], tssRegion=c(-1000,1000), flankDistance=3000,TxDb=txdb)
RNAPIIetopPromoterPathway2<-enrichPathway(RNAPIIetopPromoterGene)
dotplot(RNAPIIetopPromoterPathway2)

BRCA1dmsoPromoterReactome<-enrichPathway(peakAnnoDFBRCA1dmso$geneId)
BRCA1dmsoPromoterGene<-seq2gene(peak[[1]], tssRegion=c(-1000,1000), flankDistance=3000, TxDb=txdb)
BRCA1dmsoPromoterpathway2<-enrichPathway(BRCA1dmsoPromoterGene)
dotplot(BRCA1dmsoPromoterpathway2)

BRCA1etopPromoterReactome<-enrichPathway(peakAnnoDFBRCA1etop$geneId)
BRCA1etopPromoterGene<-seq2gene(peak[[2]], tssRegion=c(-1000,1000), flankDistance=3000, TxDb=txdb)
BRCA1etopPromoterPathway2<-enrichPathway(BRCA1etopPromoterGene)
dotplot(BRCA1etopPromoterPathway2)


```


## Profile of several ChIP peak data binding to TSS region

```{r setup, include=FALSE, echo=FALSE}


allplot<-plotAvgProf(tagMatrix, xlim=c(-3000,3000))  +
  scale_color_manual(values = c("blue", "red", "green", "orange"))
  
allplot

```


## Profile of several ChIP peak data binding to body region

```{r setup, include=FALSE, echo=FALSE}

allplotgbody<- plotPeakProf2(peak, upstream = rel(0.2), downstream = rel(0.2),
              conf = 0.95, by = "gene", type = "body",
              TxDb = txdb, facet = "row", nbin = 800)


allplotgbody

```


## ChIP peak annotation comparison

```{r setup, include=FALSE, echo=FALSE}


peakAnnoList <- lapply(peak, annotatePeak, TxDb=txdb,
                       tssRegion=c(-3000, 3000), verbose=FALSE)


plotAnnoBar(peakAnnoList)


```














